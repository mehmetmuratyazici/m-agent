<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      background: #1e1e1e;
      color: #e5e5e5;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 18px 20px 10px 20px;
      font-size: 1.3em;
      font-weight: bold;
      letter-spacing: 1px;
      background: #23272e;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .clear-chat-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .clear-chat-btn:hover {
      color: #ff6666;
      background: rgba(255, 102, 102, 0.1);
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 18px 16px 0 16px;
      overflow-y: auto;
      gap: 16px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 4px;
      font-size: 1em;
      word-break: break-word;
      box-shadow: 0 2px 8px #0002;
    }
    .message.user {
      align-self: flex-end;
      background: linear-gradient(90deg, #00c3ff 0%, #0072ff 100%);
      color: #fff;
    }
    .message.assistant {
      align-self: flex-start;
      background: #23272e;
      color: #e5e5e5;
    }

    /* Welcome message styles */
    .welcome-message {
      background: linear-gradient(135deg, #1c2128 0%, #2d3748 100%) !important;
      border-left: 4px solid #3182ce !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .welcome-content {
      max-width: 100%;
    }

    .welcome-header h2 {
      color: #63b3ed;
      margin: 0 0 12px 0;
      font-size: 1.5em;
      font-weight: 600;
    }

    .welcome-header p {
      color: #e2e8f0;
      margin: 0 0 20px 0;
      font-size: 1.1em;
      line-height: 1.6;
    }

    .welcome-features h3,
    .welcome-examples h3 {
      color: #68d391;
      margin: 16px 0 12px 0;
      font-size: 1.2em;
      font-weight: 600;
    }

    .welcome-features ul {
      margin: 0 0 20px 0;
      padding-left: 20px;
    }

    .welcome-features li {
      margin: 8px 0;
      color: #e2e8f0;
      line-height: 1.5;
    }

    .welcome-features strong {
      color: #fbb6ce;
    }

    .example-queries {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0 20px 0;
    }

    .example-btn {
      background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .example-btn:hover {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .example-btn:active {
      transform: translateY(0);
    }

    .welcome-tip {
      background: rgba(68, 211, 145, 0.1);
      border: 1px solid rgba(68, 211, 145, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
    }

    .welcome-tip p {
      margin: 0;
      color: #68d391;
      font-size: 0.95em;
    }
    .message .markdown-body {
      background: none;
      color: inherit;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    pre {
      position: relative;
      margin: 12px 0 18px 0;
    }
    pre code {
      display: block;
      background: #181a20;
      color: #e5e5e5;
      padding: 14px 12px 14px 18px;
      border-radius: 8px;
      font-size: 0.98em;
      font-family: 'Fira Mono', 'Consolas', monospace;
      overflow-x: auto;
    }
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #23272e;
      color: #00c3ff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.95em;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
      z-index: 2;
    }
    .copy-btn:hover {
      opacity: 1;
      background: #00c3ff;
      color: #fff;
    }
    .bottom-panel {
      background: #161b22;
      border-top: 1px solid #30363d;
      padding: 12px 16px;
    }
    
    .agent-controls {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .agent-status, .ai-provider-selector {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #8b949e;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
      position: relative;
    }
    
    .agent-status:hover, .ai-provider-selector:hover {
      background: #21262d;
    }

    /* Provider Selector Styles */
    .ai-provider-selector {
      user-select: none;
    }

    .provider-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      margin-top: 4px;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .provider-dropdown.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .provider-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      color: #e5e5e5;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 8px;
    }

    .provider-option:hover {
      background: #21262d;
    }

    .provider-option:first-child {
      border-radius: 6px 6px 0 0;
    }

    .provider-option:last-child {
      border-radius: 0 0 6px 6px;
    }

    .provider-option.active {
      background: #238636;
      color: #fff;
    }

    .provider-option-icon {
      font-size: 14px;
    }

    .provider-option-text {
      font-weight: 500;
    }
    
    .infinity-icon {
      font-size: 14px;
      font-weight: bold;
    }
    
    .caret {
      font-size: 10px;
      margin-left: 2px;
    }
    
    .input-bar {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 12px;
    }
    
    .input-bar textarea {
      flex: 1;
      background: #181a20;
      color: #e5e5e5;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 44px;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.4;
    }
    
    .input-bar textarea:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .input-buttons {
      display: flex;
      gap: 4px;
      align-items: flex-end;
    }
    
    .input-bar button {
      background: #30363d;
      color: #e5e5e5;
      border: none;
      border-radius: 6px;
      padding: 8px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .input-bar button:hover {
      background: #484f58;
      transform: scale(1.05);
    }
    
    .input-bar button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    #sendBtn {
      background: #238636;
    }
    
    #sendBtn:hover {
      background: #2ea043;
    }
    
    .new-chat-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #8b949e;
      font-size: 12px;
    }
    
    .new-chat-text {
      color: #8b949e;
    }
    
    .new-chat-btn {
      background: none;
      border: none;
      color: #58a6ff;
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      padding: 0;
      margin: 0;
    }
    
    .new-chat-btn:hover {
      color: #79c0ff;
    }
    
    .image-preview-container {
      position: relative;
      display: inline-block;
      margin: 8px 0;
      border-radius: 8px;
      overflow: visible;
    }
    
    .image-preview {
      max-width: 120px;
      max-height: 80px;
      display: block;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .remove-image-btn {
      position: absolute;
      top: -5px;
      background: #dc3545;
      color: white;
      border: 2px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .image-preview-container:hover .remove-image-btn {
      opacity: 1;
    }
    
    .remove-image-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    
    .input-bar textarea:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    /* Loading mesajƒ± stilleri */
    .loading-message {
      background: #23272e !important;
      border: 1px solid #333;
    }
    
    .loading-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00c3ff;
      animation: loading-dots 1.4s infinite ease-in-out;
    }
    
    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes loading-dots {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .loading-text {
      color: #00c3ff;
      font-size: 0.95em;
      font-weight: 500;
    }
    
    /* Hata mesajƒ± stilleri */
    .error-message {
      background: #2d1b1b !important;
      border: 1px solid #ff4444;
    }
    
    .error-content {
      display: flex;
      align-items: center;
    }
    
    .error-text {
      color: #ff6666;
      font-size: 0.95em;
      font-weight: 500;
    }
    
    /* Dosya i≈ülemleri stilleri */
    .file-content, .file-tree, .project-files {
      background: #1a1d23 !important;
      border: 1px solid #333;
    }
    
    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #23272e;
      border-bottom: 1px solid #333;
      border-radius: 8px 8px 0 0;
    }
    
    .file-name {
      color: #00c3ff;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    .copy-file-btn {
      background: #00c3ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8em;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .copy-file-btn:hover {
      opacity: 0.8;
    }
    
    .files-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
    }
    
    .file-item {
      padding: 4px 8px;
      color: #e5e5e5;
      font-size: 0.9em;
      border-bottom: 1px solid #333;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9em;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .file-notification.success {
      background: #28a745;
    }
    
    .file-notification.error {
      background: #dc3545;
    }

    /* Paste notification styles */
    .paste-notification {
      position: relative;
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9em;
      z-index: 1000;
      animation: slideInFromTop 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .paste-notification.success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border-left: 4px solid #155724;
    }

    .paste-notification-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .paste-icon {
      font-size: 1.2em;
    }

    .paste-text {
      font-weight: 500;
    }

    @keyframes slideInFromTop {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
  <link href="{{styleUri}}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="{{scriptUri}}"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
  <div class="header">
    Chat
    <button id="clear-chat" class="clear-chat-btn" title="Clear conversation">üóëÔ∏è</button>
  </div>
  <div class="chat-container" id="chat">
  </div>
  <div class="bottom-panel">
    <div class="agent-controls">
      <div class="agent-status">
        <span class="infinity-icon">‚àû</span>
        <span class="agent-text">Agent</span>
        <span class="caret">^</span>
      </div>
      <div class="ai-provider-selector" id="providerSelector">
        <span class="provider-icon" id="providerIcon">ü§ñ</span>
        <span class="provider-text" id="providerText">Gemini</span>
        <span class="caret">^</span>
        <div class="provider-dropdown" id="providerDropdown">
          <div class="provider-option" data-provider="gemini">
            <span class="provider-option-icon">ü§ñ</span>
            <span class="provider-option-text">Gemini</span>
          </div>
          <div class="provider-option" data-provider="deepseek">
            <span class="provider-option-icon">üß†</span>
            <span class="provider-option-text">DeepSeek</span>
          </div>
          <div class="provider-option" data-provider="claude">
            <span class="provider-option-icon">üß†</span>
            <span class="provider-option-text">Claude</span>
          </div>
        </div>
      </div>
    </div>
    
  <form class="input-bar" id="input-form">
      <textarea id="user-input" placeholder="Plan, search, build anything... (üì∏ Ekran resmi yapƒ±≈ütƒ±rabilirsiniz)" autocomplete="off" rows="1"></textarea>
      <div class="input-buttons">
        <button id="imageBtn" type="button" title="Resim Ekle">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor"/>
          </svg>
        </button>
        <button id="sendBtn" type="submit" title="G√∂nder">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/>
          </svg>
        </button>
      </div>
  </form>
    
    <div class="new-chat-section">
      <span class="new-chat-text">Start a new chat for better results.</span>
      <button class="new-chat-btn">New Chat</button>
    </div>
  </div>
  
  <input type="file" id="imageInput" accept="image/*" style="display: none;">
  <script>
    // Global deƒüi≈ükenler
    var vscode = null;
    var form = null;
    var input = null;
    var sendBtn = null;
    var imageBtn = null;
    var imageInput = null;
    var chat = null;
    var isLoading = false; // Loading state
    var loadingTimeout = null; // Loading timeout
    var conversationHistory = []; // Conversation history
    var selectedImage = null; // Se√ßilen resim
    var currentProvider = 'gemini'; // Mevcut AI provider

    // Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak fonksiyon
    function initializeWebview() {
      // VSCode API'sini al
      if (typeof acquireVsCodeApi !== 'undefined') {
        vscode = acquireVsCodeApi();
      }

      // DOM elementlerini al
      form = document.getElementById('input-form');
      input = document.getElementById('user-input');
      sendBtn = document.getElementById('sendBtn');
      imageBtn = document.getElementById('imageBtn');
      imageInput = document.getElementById('imageInput');
      chat = document.getElementById('chat');
      var clearChatBtn = document.getElementById('clear-chat');

      // Event listener'larƒ± ekle
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
      
      if (sendBtn) {
        sendBtn.addEventListener('click', handleSubmit);
      }
      
      if (input) {
        input.addEventListener('keypress', handleKeyPress);
        input.addEventListener('input', adjustTextareaHeight);
        input.addEventListener('paste', handlePaste);
      }
      
      if (clearChatBtn) {
        clearChatBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to clear the conversation?')) {
            clearConversationHistory();
          }
        });
      }
      
      if (imageBtn) {
        imageBtn.addEventListener('click', function() {
          imageInput.click();
        });
      }
      
      if (imageInput) {
        imageInput.addEventListener('change', handleImageSelect);
      }
      
      // New Chat butonu i√ßin event listener
      var newChatBtn = document.querySelector('.new-chat-btn');
      debugger;
      if (newChatBtn) {
        newChatBtn.addEventListener('click', function() {
          console.log('New chat button clicked');
          //if (confirm('Are you sure you want to start a new chat?')) {
            console.log('New chat confirmed');
            clearConversationHistory();
          //}
        });
      }

      // Conversation history'yi y√ºkle
      loadConversationHistory();
      
      // Sayfa y√ºklendiƒüinde history'yi otomatik y√ºkle
      setTimeout(() => {
        if (vscode) {
          vscode.postMessage({ command: 'getHistory' });
        }
      }, 500);

      // Eƒüer 2 saniye i√ßinde history y√ºklenmezse ho≈ü geldin mesajƒ±nƒ± g√∂ster
      setTimeout(() => {
        if (chat.children.length === 0) {
          addWelcomeMessage();
        }
      }, 2000);

      // Provider selector event listeners
      initializeProviderSelector();

      // Provider bilgisini al
      if (vscode) {
        vscode.postMessage({ command: 'getCurrentProvider' });
      }
    }

    // Clipboard'dan resim yapƒ±≈ütƒ±rma handler
    function handlePaste(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      let hasImage = false;
      
      // √ñnce resim var mƒ± kontrol et
      for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
          hasImage = true;
          break;
        }
      }
      
      // Eƒüer resim varsa, paste i≈ülemini engelle ve resmi i≈üle
      if (hasImage) {
        e.preventDefault(); // Varsayƒ±lan paste i≈ülemini engelle
        
        for (let item of items) {
          if (item.type.indexOf('image') !== -1) {
            const file = item.getAsFile();
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                selectedImage = e.target.result;
                showImagePreview();
                
                // Kullanƒ±cƒ±ya bildirim g√∂ster
                showPasteNotification('üì∏ Ekran resmi ba≈üarƒ±yla eklendi!');
              };
              reader.readAsDataURL(file);
            }
            break; // ƒ∞lk resmi bulduktan sonra d√∂ng√ºden √ßƒ±k
          }
        }
      }
    }

    // Resim se√ßme handler
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          selectedImage = e.target.result;
          showImagePreview();
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Resim √∂nizlemesini g√∂ster
    function showImagePreview() {
      // √ñnceki √∂nizlemeyi kaldƒ±r
      removeImagePreview();
      
      if (selectedImage) {
        const previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        previewContainer.innerHTML = `
          <img src="${selectedImage}" class="image-preview" alt="Se√ßilen resim">
          <button class="remove-image-btn" onclick="removeImage()" title="Resmi kaldƒ±r">‚úï</button>
        `;
        
        // Input bar'dan √∂nce ekle
        form.parentNode.insertBefore(previewContainer, form);
        
        // Resim y√ºklendiƒüinde scroll'u en alta kaydƒ±r
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 100);
      }
    }
    
    // Resim √∂nizlemesini kaldƒ±r
    function removeImagePreview() {
      const existingPreview = document.querySelector('.image-preview-container');
      if (existingPreview) {
        existingPreview.remove();
      }
    }
    
    // Resmi kaldƒ±r
    function removeImage() {
      selectedImage = null;
      removeImagePreview();
      if (imageInput) {
        imageInput.value = '';
      }
    }
    
    // Submit handler
    function handleSubmit(e) {
      e.preventDefault();
      sendMessage();
    }

    // Key press handler
    function handleKeyPress(e) {
      if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
        e.preventDefault();
        sendMessage();
      }
      // Shift+Enter ile alt satƒ±ra ge√ß (otomatik olarak √ßalƒ±≈üƒ±r)
      
      // Textarea y√ºksekliƒüini otomatik ayarla
      setTimeout(() => {
        adjustTextareaHeight();
      }, 0);
    }
    
    // Textarea y√ºksekliƒüini otomatik ayarla
    function adjustTextareaHeight() {
      if (input) {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      }
    }

    // Loading state'i g√ºncelle
    function setLoadingState(loading) {
      isLoading = loading;
      
      if (input) {
        input.disabled = loading;
      }
      
      if (sendBtn) {
        sendBtn.disabled = loading;
        if (loading) {
          sendBtn.style.opacity = '0.6';
          sendBtn.style.transform = 'scale(0.95)';
        } else {
          sendBtn.style.opacity = '1';
          sendBtn.style.transform = 'scale(1)';
        }
      }
      
      // Loading mesajƒ±nƒ± g√∂ster/gizle
      if (loading) {
        showLoadingMessage();
        // 30 saniye timeout ekle
        loadingTimeout = setTimeout(function() {
          if (isLoading) {
            setLoadingState(false);
            showErrorMessage('Response timeout. Please try again.');
          }
        }, 30000);
      } else {
        hideLoadingMessage();
        // Timeout'u temizle
        if (loadingTimeout) {
          clearTimeout(loadingTimeout);
          loadingTimeout = null;
        }
      }
    }

    // Loading mesajƒ±nƒ± g√∂ster
    function showLoadingMessage() {
      var loadingMsg = document.createElement('div');
      loadingMsg.className = 'message assistant loading-message';
      loadingMsg.innerHTML = `
        <div class="loading-content">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="loading-text">Generating response...</span>
        </div>
      `;
      loadingMsg.id = 'loading-message';
      chat.appendChild(loadingMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Loading mesajƒ±nƒ± gizle
    function hideLoadingMessage() {
      var loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }

    // Hata mesajƒ±nƒ± g√∂ster
    function showErrorMessage(message) {
      var errorMsg = document.createElement('div');
      errorMsg.className = 'message assistant error-message';
      errorMsg.innerHTML = `
        <div class="error-content">
          <span class="error-text">‚ö†Ô∏è ${message}</span>
        </div>
      `;
      chat.appendChild(errorMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Conversation history'yi y√ºkle
    function loadConversationHistory() {
      if (vscode) {
        vscode.postMessage({ command: 'getHistory' });
      }
    }

    // Conversation history'yi temizle
    function clearConversationHistory() {
      conversationHistory = [];
      chat.innerHTML = '';
      
      // Ho≈ü geldin mesajƒ±nƒ± ekle
      addWelcomeMessage();
      
      if (vscode) {
        vscode.postMessage({ command: 'clearChat' });
      }
    }

    // Ho≈ü geldin mesajƒ±nƒ± ekleme fonksiyonu
    function addWelcomeMessage() {
      const welcomeMessage = document.createElement('div');
      welcomeMessage.className = 'message assistant welcome-message';
      welcomeMessage.innerHTML = `
        <div class="welcome-content">
          <div class="welcome-header">
            <h2>ü§ñ AI Asistan'a Ho≈ü Geldiniz!</h2>
            <p>Size kod yazma, hata ayƒ±klama ve proje geli≈ütirme konularƒ±nda yardƒ±mcƒ± olmaktan mutluluk duyarƒ±m.</p>
          </div>
          
          <div class="welcome-features">
            <h3>üöÄ Neler yapabilirim:</h3>
            <ul>
              <li><strong>üíª Kod Yazma:</strong> Yeni kod √∂rnekleri olu≈üturma ve mevcut kodu iyile≈ütirme</li>
              <li><strong>üîç Hata Ayƒ±klama:</strong> Kod hatalarƒ±nƒ± bulma ve √ß√∂z√ºm √∂nerileri</li>
              <li><strong>üìö Kod A√ßƒ±klama:</strong> Karma≈üƒ±k kod bloklarƒ±nƒ± anla≈üƒ±lƒ±r ≈üekilde a√ßƒ±klama</li>
              <li><strong>üõ†Ô∏è Refactoring:</strong> Kodu daha temiz ve verimli hale getirme</li>
              <li><strong>üìñ Dok√ºmantasyon:</strong> README dosyalarƒ± ve kod yorumlarƒ± yazma</li>
              <li><strong>üß™ Test Yazma:</strong> Unit testler ve entegrasyon testleri olu≈üturma</li>
            </ul>
          </div>
          
          <div class="welcome-examples">
            <h3>üí° √ñrnek Sorular:</h3>
            <div class="example-queries">
              <button class="example-btn" onclick="askExample('Bu React component\'ini optimize eder misin?')">
                "Bu React component'ini optimize eder misin?"
              </button>
              <button class="example-btn" onclick="askExample('Bu JavaScript kodundaki hatayƒ± bulur musun?')">
                "Bu JavaScript kodundaki hatayƒ± bulur musun?"
              </button>
              <button class="example-btn" onclick="askExample('Bu fonksiyon i√ßin unit test yazar mƒ±sƒ±n?')">
                "Bu fonksiyon i√ßin unit test yazar mƒ±sƒ±n?"
              </button>
              <button class="example-btn" onclick="askExample('Bu algoritmanƒ±n zaman karma≈üƒ±klƒ±ƒüƒ±nƒ± analiz eder misin?')">
                "Bu algoritmanƒ±n zaman karma≈üƒ±klƒ±ƒüƒ±nƒ± analiz eder misin?"
              </button>
            </div>
          </div>
          
          <div class="welcome-tip">
            <p><strong>üí° ƒ∞pucu:</strong> Kod bloklarƒ±nƒ± payla≈ümak i√ßin dosyalarƒ± s√ºr√ºkleyip bƒ±rakabilir veya dosya yolunu yazabilirsiniz.</p>
            <p><strong>üì∏ Ekran Resmi:</strong> Ekran resmi aldƒ±ktan sonra Command+C ile kopyalayƒ±p bu alana yapƒ±≈ütƒ±rabilirsiniz!</p>
            <p><strong>ü§ñ AI Provider:</strong> Sol alttaki provider se√ßiciden Gemini veya DeepSeek arasƒ±nda se√ßim yapabilirsiniz!</p>
          </div>
        </div>
      `;
      
      chat.appendChild(welcomeMessage);
      chat.scrollTop = chat.scrollHeight;
    }

    // √ñrnek soru sorma fonksiyonu
    function askExample(question) {
      // Input alanƒ±na soruyu yaz
      const input = document.getElementById('user-input');
      if (input) {
        input.value = question;
        input.focus();
        // Textarea y√ºksekliƒüini ayarla
        if (typeof adjustTextareaHeight === 'function') {
          adjustTextareaHeight();
        }
      }
    }

    // Provider selector'ƒ± initialize et
    function initializeProviderSelector() {
      const providerSelector = document.getElementById('providerSelector');
      const providerDropdown = document.getElementById('providerDropdown');
      const providerOptions = document.querySelectorAll('.provider-option');

      if (providerSelector && providerDropdown) {
        // Dropdown toggle
        providerSelector.addEventListener('click', function(e) {
          e.stopPropagation();
          providerDropdown.classList.toggle('show');
        });

        // Provider se√ßimi
        providerOptions.forEach(option => {
          option.addEventListener('click', function(e) {
            e.stopPropagation();
            const selectedProvider = this.getAttribute('data-provider');
            changeProvider(selectedProvider);
            providerDropdown.classList.remove('show');
          });
        });

        // Dropdown'ƒ± dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
        document.addEventListener('click', function() {
          providerDropdown.classList.remove('show');
        });
      }
    }

    // Provider deƒüi≈ütir
    function changeProvider(provider) {
      currentProvider = provider;
      updateProviderUI(provider);
      
      if (vscode) {
        vscode.postMessage({ 
          command: 'changeProvider', 
          provider: provider 
        });
      }
    }

    // Provider UI'sƒ±nƒ± g√ºncelle
    function updateProviderUI(provider) {
      const providerIcon = document.getElementById('providerIcon');
      const providerText = document.getElementById('providerText');
      const providerOptions = document.querySelectorAll('.provider-option');

      // Icon ve text'i g√ºncelle
      if (providerIcon && providerText) {
        switch (provider) {
          case 'gemini':
            providerIcon.textContent = 'ü§ñ';
            providerText.textContent = 'Gemini';
            break;
          case 'deepseek':
            providerIcon.textContent = 'üß†';
            providerText.textContent = 'DeepSeek';
            break;
          case 'claude':
            providerIcon.textContent = 'üß†';
            providerText.textContent = 'Claude';
            break;
        }
      }

      // Active option'ƒ± g√ºncelle
      providerOptions.forEach(option => {
        const optionProvider = option.getAttribute('data-provider');
        if (optionProvider === provider) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    // Mesajƒ± history'ye ekle
    function addMessageToHistory(role, content) {
      conversationHistory.push({
        role: role,
        content: content,
        timestamp: Date.now()
      });
    }

    // Dosya i√ßeriƒüini g√∂ster
    function showFileContent(filePath, content) {
      var fileMsg = document.createElement('div');
      fileMsg.className = 'message assistant file-content';
      fileMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">üìÑ ${filePath}</span>
          <button class="copy-file-btn" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">Kopyala</button>
        </div>
        <pre><code class="language-plaintext">${content}</code></pre>
      `;
      chat.appendChild(fileMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Dosya aƒüacƒ±nƒ± g√∂ster
    function showFileTree(tree) {
      var treeMsg = document.createElement('div');
      treeMsg.className = 'message assistant file-tree';
      treeMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">üìÅ Proje Yapƒ±sƒ±</span>
        </div>
        <pre><code class="language-plaintext">${tree}</code></pre>
      `;
      chat.appendChild(treeMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Proje dosyalarƒ±nƒ± g√∂ster
    function showProjectFiles(files) {
      var filesMsg = document.createElement('div');
      filesMsg.className = 'message assistant project-files';
      filesMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">üìã Proje Dosyalarƒ± (${files.length})</span>
        </div>
        <div class="files-list">
          ${files.map(file => `<div class="file-item">üìÑ ${file}</div>`).join('')}
        </div>
      `;
      chat.appendChild(filesMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Dosya bildirimi g√∂ster
    function showFileNotification(message, type = 'success') {
      var notification = document.createElement('div');
      notification.className = `file-notification ${type}`;
      notification.textContent = message;
      chat.appendChild(notification);
      chat.scrollTop = chat.scrollHeight;
      
      // 5 saniye sonra kaldƒ±r
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Paste bildirimi g√∂ster
    function showPasteNotification(message) {
      var notification = document.createElement('div');
      notification.className = 'paste-notification success';
      notification.innerHTML = `
        <div class="paste-notification-content">
          <span class="paste-icon">üì∏</span>
          <span class="paste-text">${message}</span>
        </div>
      `;
      
      // Notification'ƒ± input alanƒ±nƒ±n √ºst√ºne ekle
      const inputContainer = document.querySelector('.input-bar');
      if (inputContainer && inputContainer.parentNode) {
        inputContainer.parentNode.insertBefore(notification, inputContainer);
      }
      
      // 3 saniye sonra kaldƒ±r
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Provider deƒüi≈üim bildirimi g√∂ster
    function showProviderChangeNotification(providerDisplayName) {
      var notification = document.createElement('div');
      notification.className = 'paste-notification success';
      notification.innerHTML = `
        <div class="paste-notification-content">
          <span class="paste-icon">üîÑ</span>
          <span class="paste-text">AI Provider deƒüi≈ütirildi: ${providerDisplayName}</span>
        </div>
      `;
      
      // Notification'ƒ± input alanƒ±nƒ±n √ºst√ºne ekle
      const inputContainer = document.querySelector('.input-bar');
      if (inputContainer && inputContainer.parentNode) {
        inputContainer.parentNode.insertBefore(notification, inputContainer);
      }
      
      // 3 saniye sonra kaldƒ±r
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Kopyalama fonksiyonu
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showFileNotification('‚úÖ Kopyalandƒ±!');
      }).catch(() => {
        showFileNotification('‚ùå Kopyalama ba≈üarƒ±sƒ±z', 'error');
      });
    }

    // Conversation history'yi UI'da g√∂ster
    function displayConversationHistory(history) {
      // Chat'i temizle
      chat.innerHTML = '';
      
      // Her mesajƒ± UI'da g√∂ster
      history.forEach(function(msg) {
        if (msg.role === 'user') {
          // Kullanƒ±cƒ± mesajƒ±
          var userMsg = document.createElement('div');
          userMsg.className = 'message user';
          userMsg.textContent = msg.content;
          chat.appendChild(userMsg);
        } else if (msg.role === 'assistant') {
          // Asistan mesajƒ±
          var botMsg = document.createElement('div');
          botMsg.className = 'message assistant';
          var mdBody = document.createElement('span');
          mdBody.className = 'markdown-body';
          
          // Markdown render et
          if (window.marked) {
            mdBody.innerHTML = window.marked.parse(msg.content, {
        highlight: function(code, lang) {
          if (lang && window.hljs.getLanguage(lang)) {
            return window.hljs.highlight(code, { language: lang }).value;
          }
          return window.hljs.highlightAuto(code).value;
        }
      });
            
            // Kod bloklarƒ±na kopyalama butonu ekle
            mdBody.querySelectorAll('pre code').forEach(function(block) {
        var pre = block.parentElement;
              if (pre) {
        var btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Kopyala';
        btn.onclick = function(e) {
          e.preventDefault();
          navigator.clipboard.writeText(block.textContent);
          btn.textContent = 'Kopyalandƒ±!';
          setTimeout(function() { btn.textContent = 'Kopyala'; }, 1200);
        };
        pre.style.position = 'relative';
        pre.appendChild(btn);
              }
            });
          } else {
            mdBody.textContent = msg.content;
          }
          
          botMsg.appendChild(mdBody);
          chat.appendChild(botMsg);
        }
      });
      
      // Syntax highlighting'i yenile
      if (window.hljs) {
      window.hljs.highlightAll();
    }

      // Chat'i en alta kaydƒ±r
      chat.scrollTop = chat.scrollHeight;
    }

    // Mesaj g√∂nderme fonksiyonu
    function sendMessage() {
      if (!input || !chat || !vscode) {
        return;
      }

      var value = input.value.trim();
      if (!value) return;
      
      // Eƒüer zaten loading durumundaysa, yeni mesaj g√∂nderme
      if (isLoading) {
        return;
      }
      
      // Loading state'ini aktif et
      setLoadingState(true);
      
      // Kullanƒ±cƒ± mesajƒ±nƒ± ekle
      var userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = value;
      chat.appendChild(userMsg);
      input.value = '';
      chat.scrollTop = chat.scrollHeight;
      
      // Mesajƒ± history'ye ekle
      addMessageToHistory('user', value);
      
      // VSCode'a mesaj g√∂nder
      try {
        const messageData = { command: 'sendPrompt', text: value };
        
        // Resim varsa ekle
        if (selectedImage) {
          messageData.imageData = selectedImage;
        }
        
        vscode.postMessage(messageData);
        
        // Resmi temizle
        removeImage();
      } catch (error) {
        console.error('Error sending message:', error);
        setLoadingState(false); // Hata durumunda loading'i kapat
      }
    }

    // VSCode'dan gelen mesajlarƒ± dinle
    window.addEventListener('message', function(event) {
      const message = event.data;
      
      switch (message.command) {
        case 'addResponse':
          // Loading state'ini kapat
          setLoadingState(false);
          
          // Asistan mesajƒ±nƒ± ekle
        var botMsg = document.createElement('div');
        botMsg.className = 'message assistant';
        var mdBody = document.createElement('span');
        mdBody.className = 'markdown-body';
          
          if (message.html) {
            // Extension'dan gelen render edilmi≈ü HTML
            mdBody.innerHTML = message.html;
          } else if (message.text) {
            // Ham markdown metni - webview tarafƒ±nda render et
            if (window.marked) {
              mdBody.innerHTML = window.marked.parse(message.text, {
                highlight: function(code, lang) {
                  if (lang && window.hljs.getLanguage(lang)) {
                    return window.hljs.highlight(code, { language: lang }).value;
                  }
                  return window.hljs.highlightAuto(code).value;
                }
              });
              
              // Kod bloklarƒ±na kopyalama butonu ekle
              mdBody.querySelectorAll('pre code').forEach(function(block) {
                var pre = block.parentElement;
                if (pre) {
                  var btn = document.createElement('button');
                  btn.className = 'copy-btn';
                  btn.textContent = 'Kopyala';
                  btn.onclick = function(e) {
                    e.preventDefault();
                    navigator.clipboard.writeText(block.textContent);
                    btn.textContent = 'Kopyalandƒ±!';
                    setTimeout(function() { btn.textContent = 'Kopyala'; }, 1200);
                  };
                  pre.style.position = 'relative';
                  pre.appendChild(btn);
                }
              });
            } else {
              mdBody.textContent = message.text;
            }
          }
          
        botMsg.appendChild(mdBody);
        chat.appendChild(botMsg);
          
          // Asistan mesajƒ±nƒ± history'ye ekle
          if (message.html) {
            // HTML'den text √ßƒ±kar (basit y√∂ntem)
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = message.html;
            addMessageToHistory('assistant', tempDiv.textContent || tempDiv.innerText || '');
          } else if (message.text) {
            addMessageToHistory('assistant', message.text);
          }
          
          // Syntax highlighting'i yenile
          if (window.hljs) {
        window.hljs.highlightAll();
          }
        chat.scrollTop = chat.scrollHeight;
          break;
          
        case 'historyLoaded':
          // Conversation history'yi y√ºkle
          conversationHistory = message.history || [];
          
          // Eƒüer history varsa, UI'da g√∂ster
          if (conversationHistory.length > 0) {
            displayConversationHistory(conversationHistory);
          } else {
            // History yoksa ho≈ü geldin mesajƒ±nƒ± g√∂ster
            addWelcomeMessage();
          }
          break;
          
        case 'chatCleared':
          // Chat temizlendi
          conversationHistory = [];
          break;
          
        case 'fileContent':
          // Dosya i√ßeriƒüi alƒ±ndƒ±
          showFileContent(message.filePath, message.content);
          break;
          
        case 'fileWritten':
          // Dosya yazƒ±ldƒ±
          showFileNotification('‚úÖ Dosya ba≈üarƒ±yla yazƒ±ldƒ±: ' + message.filePath);
          break;
          
        case 'fileTree':
          // Dosya aƒüacƒ± alƒ±ndƒ±
          showFileTree(message.tree);
          break;
          
        case 'projectFiles':
          // Proje dosyalarƒ± alƒ±ndƒ±
          showProjectFiles(message.files);
          break;
          
        case 'fileError':
          // Dosya hatasƒ±
          showFileNotification('‚ùå Hata: ' + message.error, 'error');
          break;
          
        case 'currentProvider':
          // Mevcut provider bilgisi alƒ±ndƒ±
          currentProvider = message.provider;
          updateProviderUI(message.provider);
          break;
          
        case 'providerChanged':
          // Provider deƒüi≈üti
          currentProvider = message.provider;
          updateProviderUI(message.provider);
          
          // Provider deƒüi≈ütiƒüinde bildirimi g√∂ster
          showProviderChangeNotification(message.displayName);
          break;
      }
    });

    // Sayfa y√ºklendiƒüinde initialize et
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeWebview);
    } else {
      initializeWebview();
    }
  </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      background: #1e1e1e;
      color: #e5e5e5;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 18px 20px 10px 20px;
      font-size: 1.3em;
      font-weight: bold;
      letter-spacing: 1px;
      background: #23272e;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .clear-chat-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .clear-chat-btn:hover {
      color: #ff6666;
      background: rgba(255, 102, 102, 0.1);
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 18px 16px 0 16px;
      overflow-y: auto;
      gap: 16px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 4px;
      font-size: 1em;
      word-break: break-word;
      box-shadow: 0 2px 8px #0002;
    }
    .message.user {
      align-self: flex-end;
      background: linear-gradient(90deg, #00c3ff 0%, #0072ff 100%);
      color: #fff;
    }
    .message.assistant {
      align-self: flex-start;
      background: #23272e;
      color: #e5e5e5;
    }
    .message .markdown-body {
      background: none;
      color: inherit;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    pre {
      position: relative;
      margin: 12px 0 18px 0;
    }
    pre code {
      display: block;
      background: #181a20;
      color: #e5e5e5;
      padding: 14px 12px 14px 18px;
      border-radius: 8px;
      font-size: 0.98em;
      font-family: 'Fira Mono', 'Consolas', monospace;
      overflow-x: auto;
    }
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #23272e;
      color: #00c3ff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.95em;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
      z-index: 2;
    }
    .copy-btn:hover {
      opacity: 1;
      background: #00c3ff;
      color: #fff;
    }
    .bottom-panel {
      background: #161b22;
      border-top: 1px solid #30363d;
      padding: 12px 16px;
    }
    
    .agent-controls {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .agent-status, .auto-mode {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #8b949e;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .agent-status:hover, .auto-mode:hover {
      background: #21262d;
    }
    
    .infinity-icon {
      font-size: 14px;
      font-weight: bold;
    }
    
    .caret {
      font-size: 10px;
      margin-left: 2px;
    }
    
    .input-bar {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 12px;
    }
    
    .input-bar textarea {
      flex: 1;
      background: #181a20;
      color: #e5e5e5;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 44px;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.4;
    }
    
    .input-bar textarea:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .input-buttons {
      display: flex;
      gap: 4px;
      align-items: flex-end;
    }
    
    .input-bar button {
      background: #30363d;
      color: #e5e5e5;
      border: none;
      border-radius: 6px;
      padding: 8px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .input-bar button:hover {
      background: #484f58;
      transform: scale(1.05);
    }
    
    .input-bar button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    #sendBtn {
      background: #238636;
    }
    
    #sendBtn:hover {
      background: #2ea043;
    }
    
    .new-chat-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #8b949e;
      font-size: 12px;
    }
    
    .new-chat-text {
      color: #8b949e;
    }
    
    .new-chat-btn {
      background: none;
      border: none;
      color: #58a6ff;
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      padding: 0;
      margin: 0;
    }
    
    .new-chat-btn:hover {
      color: #79c0ff;
    }
    
    .image-preview-container {
      position: relative;
      display: inline-block;
      margin: 8px 0;
      border-radius: 8px;
      overflow: visible;
    }
    
    .image-preview {
      max-width: 120px;
      max-height: 80px;
      display: block;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .remove-image-btn {
      position: absolute;
      top: -5px;
      background: #dc3545;
      color: white;
      border: 2px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .image-preview-container:hover .remove-image-btn {
      opacity: 1;
    }
    
    .remove-image-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    
    .input-bar textarea:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    /* Loading mesajƒ± stilleri */
    .loading-message {
      background: #23272e !important;
      border: 1px solid #333;
    }
    
    .loading-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00c3ff;
      animation: loading-dots 1.4s infinite ease-in-out;
    }
    
    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes loading-dots {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .loading-text {
      color: #00c3ff;
      font-size: 0.95em;
      font-weight: 500;
    }
    
    /* Hata mesajƒ± stilleri */
    .error-message {
      background: #2d1b1b !important;
      border: 1px solid #ff4444;
    }
    
    .error-content {
      display: flex;
      align-items: center;
    }
    
    .error-text {
      color: #ff6666;
      font-size: 0.95em;
      font-weight: 500;
    }
    
    /* Dosya i≈ülemleri stilleri */
    .file-content, .file-tree, .project-files {
      background: #1a1d23 !important;
      border: 1px solid #333;
    }
    
    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #23272e;
      border-bottom: 1px solid #333;
      border-radius: 8px 8px 0 0;
    }
    
    .file-name {
      color: #00c3ff;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    .copy-file-btn {
      background: #00c3ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8em;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .copy-file-btn:hover {
      opacity: 0.8;
    }
    
    .files-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
    }
    
    .file-item {
      padding: 4px 8px;
      color: #e5e5e5;
      font-size: 0.9em;
      border-bottom: 1px solid #333;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9em;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .file-notification.success {
      background: #28a745;
    }
    
    .file-notification.error {
      background: #dc3545;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
  <link href="{{styleUri}}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="{{scriptUri}}"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
  <div class="header">
    Chat
    <button id="clear-chat" class="clear-chat-btn" title="Clear conversation">üóëÔ∏è</button>
  </div>
  <div class="chat-container" id="chat">
  </div>
  <div class="bottom-panel">
    <div class="agent-controls">
      <div class="agent-status">
        <span class="infinity-icon">‚àû</span>
        <span class="agent-text">Agent</span>
        <span class="caret">^</span>
      </div>
      <div class="auto-mode">
        <span class="auto-text">Auto</span>
        <span class="caret">^</span>
      </div>
    </div>
    
  <form class="input-bar" id="input-form">
      <textarea id="user-input" placeholder="Plan, search, build anything" autocomplete="off" rows="1"></textarea>
      <div class="input-buttons">
        <button id="imageBtn" type="button" title="Resim Ekle">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor"/>
          </svg>
        </button>
        <button id="sendBtn" type="submit" title="G√∂nder">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/>
          </svg>
        </button>
      </div>
  </form>
    
    <div class="new-chat-section">
      <span class="new-chat-text">Start a new chat for better results.</span>
      <button class="new-chat-btn">New Chat</button>
    </div>
  </div>
  
  <input type="file" id="imageInput" accept="image/*" style="display: none;">
  <script>
    // Global deƒüi≈ükenler
    var vscode = null;
    var form = null;
    var input = null;
    var sendBtn = null;
    var imageBtn = null;
    var imageInput = null;
    var chat = null;
    var isLoading = false; // Loading state
    var loadingTimeout = null; // Loading timeout
    var conversationHistory = []; // Conversation history
    var selectedImage = null; // Se√ßilen resim

    // Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak fonksiyon
    function initializeWebview() {
      // VSCode API'sini al
      if (typeof acquireVsCodeApi !== 'undefined') {
        vscode = acquireVsCodeApi();
      }

      // DOM elementlerini al
      form = document.getElementById('input-form');
      input = document.getElementById('user-input');
      sendBtn = document.getElementById('sendBtn');
      imageBtn = document.getElementById('imageBtn');
      imageInput = document.getElementById('imageInput');
      chat = document.getElementById('chat');
      var clearChatBtn = document.getElementById('clear-chat');

      // Event listener'larƒ± ekle
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
      
      if (sendBtn) {
        sendBtn.addEventListener('click', handleSubmit);
      }
      
      if (input) {
        input.addEventListener('keypress', handleKeyPress);
        input.addEventListener('input', adjustTextareaHeight);
      }
      
      if (clearChatBtn) {
        clearChatBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to clear the conversation?')) {
            clearConversationHistory();
          }
        });
      }
      
      if (imageBtn) {
        imageBtn.addEventListener('click', function() {
          imageInput.click();
        });
      }
      
      if (imageInput) {
        imageInput.addEventListener('change', handleImageSelect);
      }
      
      // New Chat butonu i√ßin event listener
      var newChatBtn = document.querySelector('.new-chat-btn');
      if (newChatBtn) {
        newChatBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to start a new chat?')) {
            clearConversationHistory();
          }
        });
      }

      // Conversation history'yi y√ºkle
      loadConversationHistory();
      
      // Sayfa y√ºklendiƒüinde history'yi otomatik y√ºkle
      setTimeout(() => {
        if (vscode) {
          vscode.postMessage({ command: 'getHistory' });
        }
      }, 500);
    }

    // Resim se√ßme handler
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          selectedImage = e.target.result;
          showImagePreview();
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Resim √∂nizlemesini g√∂ster
    function showImagePreview() {
      // √ñnceki √∂nizlemeyi kaldƒ±r
      removeImagePreview();
      
      if (selectedImage) {
        const previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        previewContainer.innerHTML = `
          <img src="${selectedImage}" class="image-preview" alt="Se√ßilen resim">
          <button class="remove-image-btn" onclick="removeImage()" title="Resmi kaldƒ±r">‚úï</button>
        `;
        
        // Input bar'dan √∂nce ekle
        form.parentNode.insertBefore(previewContainer, form);
        
        // Resim y√ºklendiƒüinde scroll'u en alta kaydƒ±r
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 100);
      }
    }
    
    // Resim √∂nizlemesini kaldƒ±r
    function removeImagePreview() {
      const existingPreview = document.querySelector('.image-preview-container');
      if (existingPreview) {
        existingPreview.remove();
      }
    }
    
    // Resmi kaldƒ±r
    function removeImage() {
      selectedImage = null;
      removeImagePreview();
      if (imageInput) {
        imageInput.value = '';
      }
    }
    
    // Submit handler
    function handleSubmit(e) {
      e.preventDefault();
      sendMessage();
    }

    // Key press handler
    function handleKeyPress(e) {
      if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
        e.preventDefault();
        sendMessage();
      }
      // Shift+Enter ile alt satƒ±ra ge√ß (otomatik olarak √ßalƒ±≈üƒ±r)
      
      // Textarea y√ºksekliƒüini otomatik ayarla
      setTimeout(() => {
        adjustTextareaHeight();
      }, 0);
    }
    
    // Textarea y√ºksekliƒüini otomatik ayarla
    function adjustTextareaHeight() {
      if (input) {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      }
    }

    // Loading state'i g√ºncelle
    function setLoadingState(loading) {
      isLoading = loading;
      
      if (input) {
        input.disabled = loading;
      }
      
      if (sendBtn) {
        sendBtn.disabled = loading;
        if (loading) {
          sendBtn.style.opacity = '0.6';
          sendBtn.style.transform = 'scale(0.95)';
        } else {
          sendBtn.style.opacity = '1';
          sendBtn.style.transform = 'scale(1)';
        }
      }
      
      // Loading mesajƒ±nƒ± g√∂ster/gizle
      if (loading) {
        showLoadingMessage();
        // 30 saniye timeout ekle
        loadingTimeout = setTimeout(function() {
          if (isLoading) {
            setLoadingState(false);
            showErrorMessage('Response timeout. Please try again.');
          }
        }, 30000);
      } else {
        hideLoadingMessage();
        // Timeout'u temizle
        if (loadingTimeout) {
          clearTimeout(loadingTimeout);
          loadingTimeout = null;
        }
      }
    }

    // Loading mesajƒ±nƒ± g√∂ster
    function showLoadingMessage() {
      var loadingMsg = document.createElement('div');
      loadingMsg.className = 'message assistant loading-message';
      loadingMsg.innerHTML = `
        <div class="loading-content">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="loading-text">Generating response...</span>
        </div>
      `;
      loadingMsg.id = 'loading-message';
      chat.appendChild(loadingMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Loading mesajƒ±nƒ± gizle
    function hideLoadingMessage() {
      var loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }

    // Hata mesajƒ±nƒ± g√∂ster
    function showErrorMessage(message) {
      var errorMsg = document.createElement('div');
      errorMsg.className = 'message assistant error-message';
      errorMsg.innerHTML = `
        <div class="error-content">
          <span class="error-text">‚ö†Ô∏è ${message}</span>
        </div>
      `;
      chat.appendChild(errorMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Conversation history'yi y√ºkle
    function loadConversationHistory() {
      if (vscode) {
        vscode.postMessage({ command: 'getHistory' });
      }
    }

    // Conversation history'yi temizle
    function clearConversationHistory() {
      conversationHistory = [];
      chat.innerHTML = '';
      
      if (vscode) {
        vscode.postMessage({ command: 'clearChat' });
      }
    }

    // Mesajƒ± history'ye ekle
    function addMessageToHistory(role, content) {
      conversationHistory.push({
        role: role,
        content: content,
        timestamp: Date.now()
      });
    }

    // Dosya i√ßeriƒüini g√∂ster
    function showFileContent(filePath, content) {
      var fileMsg = document.createElement('div');
      fileMsg.className = 'message assistant file-content';
      fileMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">üìÑ ${filePath}</span>
          <button class="copy-file-btn" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">Kopyala</button>
        </div>
        <pre><code class="language-plaintext">${content}</code></pre>
      `;
      chat.appendChild(fileMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Dosya aƒüacƒ±nƒ± g√∂ster
    function showFileTree(tree) {
      var treeMsg = document.createElement('div');
      treeMsg.className = 'message assistant file-tree';
      treeMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">üìÅ Proje Yapƒ±sƒ±</span>
        </div>
        <pre><code class="language-plaintext">${tree}</code></pre>
      `;
      chat.appendChild(treeMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Proje dosyalarƒ±nƒ± g√∂ster
    function showProjectFiles(files) {
      var filesMsg = document.createElement('div');
      filesMsg.className = 'message assistant project-files';
      filesMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">üìã Proje Dosyalarƒ± (${files.length})</span>
        </div>
        <div class="files-list">
          ${files.map(file => `<div class="file-item">üìÑ ${file}</div>`).join('')}
        </div>
      `;
      chat.appendChild(filesMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Dosya bildirimi g√∂ster
    function showFileNotification(message, type = 'success') {
      var notification = document.createElement('div');
      notification.className = `file-notification ${type}`;
      notification.textContent = message;
      chat.appendChild(notification);
      chat.scrollTop = chat.scrollHeight;
      
      // 5 saniye sonra kaldƒ±r
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Kopyalama fonksiyonu
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showFileNotification('‚úÖ Kopyalandƒ±!');
      }).catch(() => {
        showFileNotification('‚ùå Kopyalama ba≈üarƒ±sƒ±z', 'error');
      });
    }

    // Conversation history'yi UI'da g√∂ster
    function displayConversationHistory(history) {
      // Chat'i temizle
      chat.innerHTML = '';
      
      // Her mesajƒ± UI'da g√∂ster
      history.forEach(function(msg) {
        if (msg.role === 'user') {
          // Kullanƒ±cƒ± mesajƒ±
          var userMsg = document.createElement('div');
          userMsg.className = 'message user';
          userMsg.textContent = msg.content;
          chat.appendChild(userMsg);
        } else if (msg.role === 'assistant') {
          // Asistan mesajƒ±
          var botMsg = document.createElement('div');
          botMsg.className = 'message assistant';
          var mdBody = document.createElement('span');
          mdBody.className = 'markdown-body';
          
          // Markdown render et
          if (window.marked) {
            mdBody.innerHTML = window.marked.parse(msg.content, {
        highlight: function(code, lang) {
          if (lang && window.hljs.getLanguage(lang)) {
            return window.hljs.highlight(code, { language: lang }).value;
          }
          return window.hljs.highlightAuto(code).value;
        }
      });
            
            // Kod bloklarƒ±na kopyalama butonu ekle
            mdBody.querySelectorAll('pre code').forEach(function(block) {
        var pre = block.parentElement;
              if (pre) {
        var btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Kopyala';
        btn.onclick = function(e) {
          e.preventDefault();
          navigator.clipboard.writeText(block.textContent);
          btn.textContent = 'Kopyalandƒ±!';
          setTimeout(function() { btn.textContent = 'Kopyala'; }, 1200);
        };
        pre.style.position = 'relative';
        pre.appendChild(btn);
              }
            });
          } else {
            mdBody.textContent = msg.content;
          }
          
          botMsg.appendChild(mdBody);
          chat.appendChild(botMsg);
        }
      });
      
      // Syntax highlighting'i yenile
      if (window.hljs) {
      window.hljs.highlightAll();
    }

      // Chat'i en alta kaydƒ±r
      chat.scrollTop = chat.scrollHeight;
    }

    // Mesaj g√∂nderme fonksiyonu
    function sendMessage() {
      if (!input || !chat || !vscode) {
        return;
      }

      var value = input.value.trim();
      if (!value) return;
      
      // Eƒüer zaten loading durumundaysa, yeni mesaj g√∂nderme
      if (isLoading) {
        return;
      }
      
      // Loading state'ini aktif et
      setLoadingState(true);
      
      // Kullanƒ±cƒ± mesajƒ±nƒ± ekle
      var userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = value;
      chat.appendChild(userMsg);
      input.value = '';
      chat.scrollTop = chat.scrollHeight;
      
      // Mesajƒ± history'ye ekle
      addMessageToHistory('user', value);
      
      // VSCode'a mesaj g√∂nder
      try {
        const messageData = { command: 'sendPrompt', text: value };
        
        // Resim varsa ekle
        if (selectedImage) {
          messageData.imageData = selectedImage;
        }
        
        vscode.postMessage(messageData);
        
        // Resmi temizle
        removeImage();
      } catch (error) {
        console.error('Error sending message:', error);
        setLoadingState(false); // Hata durumunda loading'i kapat
      }
    }

    // VSCode'dan gelen mesajlarƒ± dinle
    window.addEventListener('message', function(event) {
      const message = event.data;
      
      switch (message.command) {
        case 'addResponse':
          // Loading state'ini kapat
          setLoadingState(false);
          
          // Asistan mesajƒ±nƒ± ekle
        var botMsg = document.createElement('div');
        botMsg.className = 'message assistant';
        var mdBody = document.createElement('span');
        mdBody.className = 'markdown-body';
          
          if (message.html) {
            // Extension'dan gelen render edilmi≈ü HTML
            mdBody.innerHTML = message.html;
          } else if (message.text) {
            // Ham markdown metni - webview tarafƒ±nda render et
            if (window.marked) {
              mdBody.innerHTML = window.marked.parse(message.text, {
                highlight: function(code, lang) {
                  if (lang && window.hljs.getLanguage(lang)) {
                    return window.hljs.highlight(code, { language: lang }).value;
                  }
                  return window.hljs.highlightAuto(code).value;
                }
              });
              
              // Kod bloklarƒ±na kopyalama butonu ekle
              mdBody.querySelectorAll('pre code').forEach(function(block) {
                var pre = block.parentElement;
                if (pre) {
                  var btn = document.createElement('button');
                  btn.className = 'copy-btn';
                  btn.textContent = 'Kopyala';
                  btn.onclick = function(e) {
                    e.preventDefault();
                    navigator.clipboard.writeText(block.textContent);
                    btn.textContent = 'Kopyalandƒ±!';
                    setTimeout(function() { btn.textContent = 'Kopyala'; }, 1200);
                  };
                  pre.style.position = 'relative';
                  pre.appendChild(btn);
                }
              });
            } else {
              mdBody.textContent = message.text;
            }
          }
          
        botMsg.appendChild(mdBody);
        chat.appendChild(botMsg);
          
          // Asistan mesajƒ±nƒ± history'ye ekle
          if (message.html) {
            // HTML'den text √ßƒ±kar (basit y√∂ntem)
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = message.html;
            addMessageToHistory('assistant', tempDiv.textContent || tempDiv.innerText || '');
          } else if (message.text) {
            addMessageToHistory('assistant', message.text);
          }
          
          // Syntax highlighting'i yenile
          if (window.hljs) {
        window.hljs.highlightAll();
          }
        chat.scrollTop = chat.scrollHeight;
          break;
          
        case 'historyLoaded':
          // Conversation history'yi y√ºkle
          conversationHistory = message.history || [];
          
          // Eƒüer history varsa, UI'da g√∂ster
          if (conversationHistory.length > 0) {
            displayConversationHistory(conversationHistory);
          }
          break;
          
        case 'chatCleared':
          // Chat temizlendi
          conversationHistory = [];
          break;
          
        case 'fileContent':
          // Dosya i√ßeriƒüi alƒ±ndƒ±
          showFileContent(message.filePath, message.content);
          break;
          
        case 'fileWritten':
          // Dosya yazƒ±ldƒ±
          showFileNotification('‚úÖ Dosya ba≈üarƒ±yla yazƒ±ldƒ±: ' + message.filePath);
          break;
          
        case 'fileTree':
          // Dosya aƒüacƒ± alƒ±ndƒ±
          showFileTree(message.tree);
          break;
          
        case 'projectFiles':
          // Proje dosyalarƒ± alƒ±ndƒ±
          showProjectFiles(message.files);
          break;
          
        case 'fileError':
          // Dosya hatasƒ±
          showFileNotification('‚ùå Hata: ' + message.error, 'error');
          break;
      }
    });

    // Sayfa y√ºklendiƒüinde initialize et
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeWebview);
    } else {
      initializeWebview();
    }
  </script>
</body>
</html> 
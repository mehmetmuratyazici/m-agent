<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      background: #1e1e1e;
      color: #e5e5e5;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 18px 20px 10px 20px;
      font-size: 1.3em;
      font-weight: bold;
      letter-spacing: 1px;
      background: #23272e;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .clear-chat-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .clear-chat-btn:hover {
      color: #ff6666;
      background: rgba(255, 102, 102, 0.1);
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 18px 16px 0 16px;
      overflow-y: auto;
      gap: 16px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 4px;
      font-size: 1em;
      word-break: break-word;
      box-shadow: 0 2px 8px #0002;
    }
    .message.user {
      align-self: flex-end;
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      background: none;
      color: #fff;
    }
    .message.assistant {
      align-self: flex-start;
      background: #23272e;
      color: #e5e5e5;
    }

    /* Welcome message styles */
    .welcome-message {
      background: linear-gradient(135deg, #1c2128 0%, #2d3748 100%) !important;
      border-left: 4px solid #3182ce !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .welcome-content {
      max-width: 100%;
    }

    .welcome-header h2 {
      color: #63b3ed;
      margin: 0 0 12px 0;
      font-size: 1.5em;
      font-weight: 600;
    }

    .welcome-header p {
      color: #e2e8f0;
      margin: 0 0 20px 0;
      font-size: 1.1em;
      line-height: 1.6;
    }

    .welcome-features h3,
    .welcome-examples h3 {
      color: #68d391;
      margin: 16px 0 12px 0;
      font-size: 1.2em;
      font-weight: 600;
    }

    .welcome-features ul {
      margin: 0 0 20px 0;
      padding-left: 20px;
    }

    .welcome-features li {
      margin: 8px 0;
      color: #e2e8f0;
      line-height: 1.5;
    }

    .welcome-features strong {
      color: #fbb6ce;
    }

    .example-queries {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0 20px 0;
    }

    .example-btn {
      background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .example-btn:hover {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .example-btn:active {
      transform: translateY(0);
    }

    .welcome-tip {
      background: rgba(68, 211, 145, 0.1);
      border: 1px solid rgba(68, 211, 145, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
    }

    .welcome-tip p {
      margin: 0;
      color: #68d391;
      font-size: 0.95em;
    }
    .message .markdown-body {
      background: none;
      color: inherit;
      padding: 0;
      border-radius: 0;
      font-size: 1em;
    }
    pre {
      position: relative;
      margin: 12px 0 18px 0;
    }
    pre code {
      display: block;
      background: #181a20;
      color: #e5e5e5;
      padding: 14px 12px 14px 18px;
      border-radius: 8px;
      font-size: 0.98em;
      font-family: 'Fira Mono', 'Consolas', monospace;
      overflow-x: auto;
    }
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 14px;
      background: #23272e;
      color: #00c3ff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.95em;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
      z-index: 2;
    }
    .copy-btn:hover {
      opacity: 1;
      background: #00c3ff;
      color: #fff;
    }
    .bottom-panel {
      background: #161b22;
      border-top: 1px solid #30363d;
      padding: 12px 16px;
    }
    
    .agent-controls {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .agent-status, .ai-provider-selector {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #8b949e;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
      position: relative;
    }
    
    .agent-status:hover, .ai-provider-selector:hover {
      background: #21262d;
    }

    /* Provider Selector Styles */
    .ai-provider-selector {
      user-select: none;
    }

    .provider-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      margin-top: 4px;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .provider-dropdown.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .provider-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      color: #e5e5e5;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 8px;
    }

    .provider-option:hover {
      background: #21262d;
    }

    .provider-option:first-child {
      border-radius: 6px 6px 0 0;
    }

    .provider-option:last-child {
      border-radius: 0 0 6px 6px;
    }

    .provider-option.active {
      background: #238636;
      color: #fff;
    }

    .provider-option-icon {
      font-size: 14px;
    }

    .provider-option-text {
      font-weight: 500;
    }
    
    .infinity-icon {
      font-size: 14px;
      font-weight: bold;
    }
    
    .caret {
      font-size: 10px;
      margin-left: 2px;
    }
    
    .input-bar {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 12px;
    }
    
    .input-bar textarea {
      flex: 1;
      background: #181a20;
      color: #e5e5e5;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 44px;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.4;
    }
    
    .input-bar textarea:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .input-buttons {
      display: flex;
      gap: 4px;
      align-items: flex-end;
    }
    
    .input-bar button {
      background: #30363d;
      color: #e5e5e5;
      border: none;
      border-radius: 6px;
      padding: 8px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .input-bar button:hover {
      background: #484f58;
      transform: scale(1.05);
    }
    
    .input-bar button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    #sendBtn {
      background: #238636;
    }
    
    #sendBtn:hover {
      background: #2ea043;
    }
    
    .new-chat-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #8b949e;
      font-size: 12px;
    }
    
    .new-chat-text {
      color: #8b949e;
    }
    
    .new-chat-btn {
      background: none;
      border: none;
      color: #58a6ff;
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      padding: 0;
      margin: 0;
    }
    
    .new-chat-btn:hover {
      color: #79c0ff;
    }
    
    .image-preview-container {
      position: relative;
      display: inline-block;
      margin: 8px 0;
      border-radius: 8px;
      overflow: visible;
    }
    
    .image-preview {
      max-width: 120px;
      max-height: 80px;
      display: block;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .remove-image-btn {
      position: absolute;
      top: -5px;
      background: #dc3545;
      color: white;
      border: 2px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .image-preview-container:hover .remove-image-btn {
      opacity: 1;
    }
    
    .remove-image-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }
    
    .input-bar textarea:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    /* Loading mesajÄ± stilleri */
    .loading-message {
      background: #23272e !important;
      border: 1px solid #333;
    }
    
    .loading-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00c3ff;
      animation: loading-dots 1.4s infinite ease-in-out;
    }
    
    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes loading-dots {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .loading-text {
      color: #00c3ff;
      font-size: 0.95em;
      font-weight: 500;
    }
    
    /* Hata mesajÄ± stilleri */
    .error-message {
      background: #2d1b1b !important;
      border: 1px solid #ff4444;
    }
    
    .error-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .error-text {
      color: #ff6666;
      font-size: 0.95em;
      font-weight: 500;
    }
    
    .retry-container {
      display: flex;
      justify-content: flex-start;
      margin-top: 8px;
    }
    
    .retry-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .retry-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
    }
    
    .retry-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(76, 175, 80, 0.3);
    }
    
    /* KullanÄ±cÄ± mesajlarÄ± iÃ§in retry button stilleri */
    
    .user-message-content {
      flex: 1;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 1em;
      line-height: 1.4;
      word-wrap: break-word;
      max-width: 70%;
      margin-left: auto;
    }
    
    .user-retry-container {
      display: flex;
      align-items: center;
      margin-top: 4px;
    }
    
    .user-retry-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      opacity: 0.7;
    }
    
    .user-retry-btn:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .user-retry-btn:active {
      transform: scale(0.95);
    }
    
    .message.user:hover .user-retry-btn {
      opacity: 1;
    }
    
    /* Dosya iÅlemleri stilleri */
    .file-content, .file-tree, .project-files {
      background: #1a1d23 !important;
      border: 1px solid #333;
    }
    
    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #23272e;
      border-bottom: 1px solid #333;
      border-radius: 8px 8px 0 0;
    }
    
    .file-name {
      color: #00c3ff;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    .copy-file-btn {
      background: #00c3ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8em;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .copy-file-btn:hover {
      opacity: 0.8;
    }
    
    .files-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
    }
    
    .file-item {
      padding: 4px 8px;
      color: #e5e5e5;
      font-size: 0.9em;
      border-bottom: 1px solid #333;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9em;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .file-notification.success {
      background: #28a745;
    }
    
    .file-notification.error {
      background: #dc3545;
    }

    /* Paste notification styles */
    .paste-notification {
      position: relative;
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9em;
      z-index: 1000;
      animation: slideInFromTop 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .paste-notification.success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border-left: 4px solid #155724;
    }

    .paste-notification-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .paste-icon {
      font-size: 1.2em;
    }

    .paste-text {
      font-weight: 500;
    }

    @keyframes slideInFromTop {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
  <link href="{{styleUri}}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="{{scriptUri}}"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
  <div class="header">
    Chat
    <button id="clear-chat" class="clear-chat-btn" title="Clear conversation">ðï¸</button>
  </div>
  <div class="chat-container" id="chat">
  </div>
  <div class="bottom-panel">
    <div class="agent-controls">
      <div class="agent-status">
        <span class="infinity-icon">â</span>
        <span class="agent-text">Agent</span>
        <span class="caret">^</span>
      </div>
      <div class="ai-provider-selector" id="providerSelector">
        <span class="provider-icon" id="providerIcon">ð¤</span>
        <span class="provider-text" id="providerText">Gemini</span>
        <span class="caret">^</span>
        <div class="provider-dropdown" id="providerDropdown">
          <div class="provider-option" data-provider="gemini">
            <span class="provider-option-icon">ð¤</span>
            <span class="provider-option-text">Gemini</span>
          </div>
          <div class="provider-option" data-provider="deepseek">
            <span class="provider-option-icon">ð§ </span>
            <span class="provider-option-text">DeepSeek</span>
          </div>
          <div class="provider-option" data-provider="claude">
            <span class="provider-option-icon">ð§ </span>
            <span class="provider-option-text">Claude</span>
          </div>
        </div>
      </div>
    </div>
    
  <form class="input-bar" id="input-form">
      <textarea id="user-input" placeholder="Plan, search, build anything... (ð¸ Ekran resmi yapÄ±ÅtÄ±rabilirsiniz)" autocomplete="off" rows="1"></textarea>
      <div class="input-buttons">
        <button id="imageBtn" type="button" title="Resim Ekle">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor"/>
          </svg>
        </button>
        <button id="sendBtn" type="submit" title="GÃ¶nder">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor"/>
          </svg>
        </button>
      </div>
  </form>
    
    <div class="new-chat-section">
      <span class="new-chat-text">Start a new chat for better results.</span>
      <button class="new-chat-btn">New Chat</button>
    </div>
  </div>
  
  <input type="file" id="imageInput" accept="image/*" style="display: none;">
  <script>
    // Global deÄiÅkenler
    var vscode = null;
    var form = null;
    var input = null;
    var sendBtn = null;
    var imageBtn = null;
    var imageInput = null;
    var chat = null;
    var isLoading = false; // Loading state
    var loadingTimeout = null; // Loading timeout
    var conversationHistory = []; // Conversation history
    var selectedImage = null; // SeÃ§ilen resim
    var currentProvider = 'gemini'; // Mevcut AI provider
    var lastFailedMessage = null; // Son baÅarÄ±sÄ±z olan mesajÄ± saklamak iÃ§in

    // Sayfa yÃ¼klendiÄinde Ã§alÄ±Åacak fonksiyon
    function initializeWebview() {
      // VSCode API'sini al
      if (typeof acquireVsCodeApi !== 'undefined') {
        vscode = acquireVsCodeApi();
      }

      // DOM elementlerini al
      form = document.getElementById('input-form');
      input = document.getElementById('user-input');
      sendBtn = document.getElementById('sendBtn');
      imageBtn = document.getElementById('imageBtn');
      imageInput = document.getElementById('imageInput');
      chat = document.getElementById('chat');
      var clearChatBtn = document.getElementById('clear-chat');

      // Event listener'larÄ± ekle
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
      
      if (sendBtn) {
        sendBtn.addEventListener('click', handleSubmit);
      }
      
      if (input) {
        input.addEventListener('keypress', handleKeyPress);
        input.addEventListener('input', adjustTextareaHeight);
        input.addEventListener('paste', handlePaste);
      }
      
      if (clearChatBtn) {
        clearChatBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to clear the conversation?')) {
            clearConversationHistory();
          }
        });
      }
      
      if (imageBtn) {
        imageBtn.addEventListener('click', function() {
          imageInput.click();
        });
      }
      
      if (imageInput) {
        imageInput.addEventListener('change', handleImageSelect);
      }
      
      // New Chat butonu iÃ§in event listener
      var newChatBtn = document.querySelector('.new-chat-btn');
      debugger;
      if (newChatBtn) {
        newChatBtn.addEventListener('click', function() {
          console.log('New chat button clicked');
          //if (confirm('Are you sure you want to start a new chat?')) {
            console.log('New chat confirmed');
            clearConversationHistory();
          //}
        });
      }

      // Conversation history'yi yÃ¼kle
      loadConversationHistory();
      
      // Sayfa yÃ¼klendiÄinde history'yi otomatik yÃ¼kle
      setTimeout(() => {
        if (vscode) {
          vscode.postMessage({ command: 'getHistory' });
        }
      }, 500);

      // EÄer 2 saniye iÃ§inde history yÃ¼klenmezse hoÅ geldin mesajÄ±nÄ± gÃ¶ster
      setTimeout(() => {
        if (chat.children.length === 0) {
          //addWelcomeMessage();
        }
      }, 2000);

      // Provider selector event listeners
      initializeProviderSelector();

      // Provider bilgisini al
      if (vscode) {
        vscode.postMessage({ command: 'getCurrentProvider' });
      }
    }

    // Clipboard'dan resim yapÄ±ÅtÄ±rma handler
    function handlePaste(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      let hasImage = false;
      
      // Ãnce resim var mÄ± kontrol et
      for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
          hasImage = true;
          break;
        }
      }
      
      // EÄer resim varsa, paste iÅlemini engelle ve resmi iÅle
      if (hasImage) {
        e.preventDefault(); // VarsayÄ±lan paste iÅlemini engelle
        
        for (let item of items) {
          if (item.type.indexOf('image') !== -1) {
            const file = item.getAsFile();
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                selectedImage = e.target.result;
                showImagePreview();
                
                // KullanÄ±cÄ±ya bildirim gÃ¶ster
                showPasteNotification('ð¸ Ekran resmi baÅarÄ±yla eklendi!');
              };
              reader.readAsDataURL(file);
            }
            break; // Ä°lk resmi bulduktan sonra dÃ¶ngÃ¼den Ã§Ä±k
          }
        }
      }
    }

    // Resim seÃ§me handler
    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          selectedImage = e.target.result;
          showImagePreview();
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Resim Ã¶nizlemesini gÃ¶ster
    function showImagePreview() {
      // Ãnceki Ã¶nizlemeyi kaldÄ±r
      removeImagePreview();
      
      if (selectedImage) {
        const previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        previewContainer.innerHTML = `
          <img src="${selectedImage}" class="image-preview" alt="SeÃ§ilen resim">
          <button class="remove-image-btn" onclick="removeImage()" title="Resmi kaldÄ±r">â</button>
        `;
        
        // Input bar'dan Ã¶nce ekle
        form.parentNode.insertBefore(previewContainer, form);
        
        // Resim yÃ¼klendiÄinde scroll'u en alta kaydÄ±r
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 100);
      }
    }
    
    // Resim Ã¶nizlemesini kaldÄ±r
    function removeImagePreview() {
      const existingPreview = document.querySelector('.image-preview-container');
      if (existingPreview) {
        existingPreview.remove();
      }
    }
    
    // Resmi kaldÄ±r
    function removeImage() {
      selectedImage = null;
      removeImagePreview();
      if (imageInput) {
        imageInput.value = '';
      }
    }
    
    // Submit handler
    function handleSubmit(e) {
      e.preventDefault();
      sendMessage();
    }

    // Key press handler
    function handleKeyPress(e) {
      if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
        e.preventDefault();
        sendMessage();
      }
      // Shift+Enter ile alt satÄ±ra geÃ§ (otomatik olarak Ã§alÄ±ÅÄ±r)
      
      // Textarea yÃ¼ksekliÄini otomatik ayarla
      setTimeout(() => {
        adjustTextareaHeight();
      }, 0);
    }
    
    // Textarea yÃ¼ksekliÄini otomatik ayarla
    function adjustTextareaHeight() {
      if (input) {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      }
    }

    // Loading state'i gÃ¼ncelle
    function setLoadingState(loading) {
      isLoading = loading;
      
      if (input) {
        input.disabled = loading;
      }
      
      if (sendBtn) {
        sendBtn.disabled = loading;
        if (loading) {
          sendBtn.style.opacity = '0.6';
          sendBtn.style.transform = 'scale(0.95)';
        } else {
          sendBtn.style.opacity = '1';
          sendBtn.style.transform = 'scale(1)';
        }
      }
      
      // Loading mesajÄ±nÄ± gÃ¶ster/gizle
      if (loading) {
        showLoadingMessage();
        // 3.5 dakika timeout ekle (backend timeout'tan biraz fazla)
        loadingTimeout = setTimeout(function() {
          if (isLoading) {
            setLoadingState(false);
            showErrorMessage('Response timeout. Please try again.');
          }
        }, 210000);
      } else {
        hideLoadingMessage();
        // Timeout'u temizle
        if (loadingTimeout) {
          clearTimeout(loadingTimeout);
          loadingTimeout = null;
        }
      }
    }

    // Loading mesajÄ±nÄ± gÃ¶ster
    function showLoadingMessage() {
      var loadingMsg = document.createElement('div');
      loadingMsg.className = 'message assistant loading-message';
      loadingMsg.innerHTML = `
        <div class="loading-content">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="loading-text">Generating response...</span>
        </div>
      `;
      loadingMsg.id = 'loading-message';
      chat.appendChild(loadingMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Loading mesajÄ±nÄ± gizle
    function hideLoadingMessage() {
      var loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }

    // Hata mesajÄ±nÄ± gÃ¶ster
    function showErrorMessage(message) {
      var errorMsg = document.createElement('div');
      errorMsg.className = 'message assistant error-message';
      errorMsg.innerHTML = `
        <div class="error-content">
          <span class="error-text">â ï¸ ${message}</span>
          ${lastFailedMessage ? `
            <div class="retry-container">
              <button class="retry-btn" onclick="retryLastMessage()">
                ð Yeniden GÃ¶nder
              </button>
            </div>
          ` : ''}
        </div>
      `;
      chat.appendChild(errorMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // KullanÄ±cÄ± mesajÄ± oluÅtur (retry butonu ile birlikte)
    function createUserMessage(messageText, imageData) {
      var userMsg = document.createElement('div');
      userMsg.className = 'message user';
      
      var messageContent = document.createElement('div');
      messageContent.className = 'user-message-content';
      messageContent.textContent = messageText;
      
      var retryContainer = document.createElement('div');
      retryContainer.className = 'user-retry-container';
      
      var retryBtn = document.createElement('button');
      retryBtn.className = 'user-retry-btn';
      retryBtn.innerHTML = 'ð';
      retryBtn.title = 'Bu mesajÄ± yeniden gÃ¶nder';
      
      // Retry button click handler
      retryBtn.onclick = function(e) {
        e.preventDefault();
        retryMessage(messageText, imageData);
      };
      
      retryContainer.appendChild(retryBtn);
      userMsg.appendChild(messageContent);
      userMsg.appendChild(retryContainer);
      
      chat.appendChild(userMsg);
    }

    // Belirli bir mesajÄ± yeniden gÃ¶nder
    function retryMessage(messageText, imageData) {
      if (isLoading) {
        return;
      }
      
      // Input alanÄ±nÄ± doldur
      if (input) {
        input.value = messageText;
      }
      
      // EÄer resim varsa, seÃ§ili resmi geri yÃ¼kle
      if (imageData) {
        selectedImage = imageData;
        showImagePreview();
      }
      
      // MesajÄ± gÃ¶nder
      sendMessage();
    }

    // Son mesajÄ± yeniden gÃ¶nder (eski fonksiyon)
    function retryLastMessage() {
      if (!lastFailedMessage || isLoading) {
        return;
      }
      
      // Input alanÄ±nÄ± geÃ§ici olarak doldur
      if (input) {
        input.value = lastFailedMessage.text;
      }
      
      // EÄer resim varsa, seÃ§ili resmi geri yÃ¼kle
      if (lastFailedMessage.imageData) {
        selectedImage = lastFailedMessage.imageData;
        showImagePreview();
      }
      
      // MesajÄ± gÃ¶nder
      sendMessage();
    }

    // Conversation history'yi yÃ¼kle
    function loadConversationHistory() {
      if (vscode) {
        vscode.postMessage({ command: 'getHistory' });
      }
    }

    // Conversation history'yi temizle
    function clearConversationHistory() {
      console.log('Clearing conversation history');
      conversationHistory = [];
      chat.innerHTML = '';
      
      // HoÅ geldin mesajÄ±nÄ± ekle
      addWelcomeMessage();
      
      if (vscode) {
        vscode.postMessage({ command: 'clearChat' });
      }
    }

    // HoÅ geldin mesajÄ±nÄ± ekleme fonksiyonu
    function addWelcomeMessage() {
      console.log('Adding welcome message');
      const welcomeMessage = document.createElement('div');
      welcomeMessage.className = 'message assistant welcome-message';
      welcomeMessage.innerHTML = `
        <div class="welcome-content">
          <div class="welcome-header">
            <h2>ð¤ AI Asistan'a HoÅ Geldiniz!</h2>
            <p>Size kod yazma, hata ayÄ±klama ve proje geliÅtirme konularÄ±nda yardÄ±mcÄ± olmaktan mutluluk duyarÄ±m.</p>
          </div>
          
          <div class="welcome-features">
            <h3>ð Neler yapabilirim:</h3>
            <ul>
              <li><strong>ð» Kod Yazma:</strong> Yeni kod Ã¶rnekleri oluÅturma ve mevcut kodu iyileÅtirme</li>
              <li><strong>ð Hata AyÄ±klama:</strong> Kod hatalarÄ±nÄ± bulma ve Ã§Ã¶zÃ¼m Ã¶nerileri</li>
              <li><strong>ð Kod AÃ§Ä±klama:</strong> KarmaÅÄ±k kod bloklarÄ±nÄ± anlaÅÄ±lÄ±r Åekilde aÃ§Ä±klama</li>
              <li><strong>ð ï¸ Refactoring:</strong> Kodu daha temiz ve verimli hale getirme</li>
              <li><strong>ð DokÃ¼mantasyon:</strong> README dosyalarÄ± ve kod yorumlarÄ± yazma</li>
              <li><strong>ð§ª Test Yazma:</strong> Unit testler ve entegrasyon testleri oluÅturma</li>
            </ul>
          </div>
          
          <div class="welcome-examples">
            <h3>ð¡ Ãrnek Sorular:</h3>
            <div class="example-queries">
              <button class="example-btn" onclick="askExample('Bu React component\'ini optimize eder misin?')">
                "Bu React component'ini optimize eder misin?"
              </button>
              <button class="example-btn" onclick="askExample('Bu JavaScript kodundaki hatayÄ± bulur musun?')">
                "Bu JavaScript kodundaki hatayÄ± bulur musun?"
              </button>
              <button class="example-btn" onclick="askExample('Bu fonksiyon iÃ§in unit test yazar mÄ±sÄ±n?')">
                "Bu fonksiyon iÃ§in unit test yazar mÄ±sÄ±n?"
              </button>
              <button class="example-btn" onclick="askExample('Bu algoritmanÄ±n zaman karmaÅÄ±klÄ±ÄÄ±nÄ± analiz eder misin?')">
                "Bu algoritmanÄ±n zaman karmaÅÄ±klÄ±ÄÄ±nÄ± analiz eder misin?"
              </button>
            </div>
          </div>
          
          <div class="welcome-tip">
            <p><strong>ð¡ Ä°pucu:</strong> Kod bloklarÄ±nÄ± paylaÅmak iÃ§in dosyalarÄ± sÃ¼rÃ¼kleyip bÄ±rakabilir veya dosya yolunu yazabilirsiniz.</p>
            <p><strong>ð¸ Ekran Resmi:</strong> Ekran resmi aldÄ±ktan sonra Command+C ile kopyalayÄ±p bu alana yapÄ±ÅtÄ±rabilirsiniz!</p>
            <p><strong>ð¤ AI Provider:</strong> Sol alttaki provider seÃ§iciden Gemini veya DeepSeek arasÄ±nda seÃ§im yapabilirsiniz!</p>
          </div>
        </div>
      `;
      
      chat.appendChild(welcomeMessage);
      chat.scrollTop = chat.scrollHeight;
    }

    // Ãrnek soru sorma fonksiyonu
    function askExample(question) {
      // Input alanÄ±na soruyu yaz
      const input = document.getElementById('user-input');
      if (input) {
        input.value = question;
        input.focus();
        // Textarea yÃ¼ksekliÄini ayarla
        if (typeof adjustTextareaHeight === 'function') {
          adjustTextareaHeight();
        }
      }
    }

    // Provider selector'Ä± initialize et
    function initializeProviderSelector() {
      const providerSelector = document.getElementById('providerSelector');
      const providerDropdown = document.getElementById('providerDropdown');
      const providerOptions = document.querySelectorAll('.provider-option');

      if (providerSelector && providerDropdown) {
        // Dropdown toggle
        providerSelector.addEventListener('click', function(e) {
          e.stopPropagation();
          providerDropdown.classList.toggle('show');
        });

        // Provider seÃ§imi
        providerOptions.forEach(option => {
          option.addEventListener('click', function(e) {
            e.stopPropagation();
            const selectedProvider = this.getAttribute('data-provider');
            changeProvider(selectedProvider);
            providerDropdown.classList.remove('show');
          });
        });

        // Dropdown'Ä± dÄ±ÅarÄ± tÄ±klayÄ±nca kapat
        document.addEventListener('click', function() {
          providerDropdown.classList.remove('show');
        });
      }
    }

    // Provider deÄiÅtir
    function changeProvider(provider) {
      currentProvider = provider;
      updateProviderUI(provider);
      
      if (vscode) {
        vscode.postMessage({ 
          command: 'changeProvider', 
          provider: provider 
        });
      }
    }

    // Provider UI'sÄ±nÄ± gÃ¼ncelle
    function updateProviderUI(provider) {
      const providerIcon = document.getElementById('providerIcon');
      const providerText = document.getElementById('providerText');
      const providerOptions = document.querySelectorAll('.provider-option');

      // Icon ve text'i gÃ¼ncelle
      if (providerIcon && providerText) {
        switch (provider) {
          case 'gemini':
            providerIcon.textContent = 'ð¤';
            providerText.textContent = 'Gemini';
            break;
          case 'deepseek':
            providerIcon.textContent = 'ð§ ';
            providerText.textContent = 'DeepSeek';
            break;
          case 'claude':
            providerIcon.textContent = 'ð§ ';
            providerText.textContent = 'Claude';
            break;
        }
      }

      // Active option'Ä± gÃ¼ncelle
      providerOptions.forEach(option => {
        const optionProvider = option.getAttribute('data-provider');
        if (optionProvider === provider) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    // MesajÄ± history'ye ekle
    function addMessageToHistory(role, content) {
      conversationHistory.push({
        role: role,
        content: content,
        timestamp: Date.now()
      });
    }

    // Dosya iÃ§eriÄini gÃ¶ster
    function showFileContent(filePath, content) {
      var fileMsg = document.createElement('div');
      fileMsg.className = 'message assistant file-content';
      fileMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">ð ${filePath}</span>
          <button class="copy-file-btn" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">Kopyala</button>
        </div>
        <pre><code class="language-plaintext">${content}</code></pre>
      `;
      chat.appendChild(fileMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Dosya aÄacÄ±nÄ± gÃ¶ster
    function showFileTree(tree) {
      var treeMsg = document.createElement('div');
      treeMsg.className = 'message assistant file-tree';
      treeMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">ð Proje YapÄ±sÄ±</span>
        </div>
        <pre><code class="language-plaintext">${tree}</code></pre>
      `;
      chat.appendChild(treeMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Proje dosyalarÄ±nÄ± gÃ¶ster
    function showProjectFiles(files) {
      var filesMsg = document.createElement('div');
      filesMsg.className = 'message assistant project-files';
      filesMsg.innerHTML = `
        <div class="file-header">
          <span class="file-name">ð Proje DosyalarÄ± (${files.length})</span>
        </div>
        <div class="files-list">
          ${files.map(file => `<div class="file-item">ð ${file}</div>`).join('')}
        </div>
      `;
      chat.appendChild(filesMsg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Dosya bildirimi gÃ¶ster
    function showFileNotification(message, type = 'success') {
      var notification = document.createElement('div');
      notification.className = `file-notification ${type}`;
      notification.textContent = message;
      chat.appendChild(notification);
      chat.scrollTop = chat.scrollHeight;
      
      // 5 saniye sonra kaldÄ±r
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Paste bildirimi gÃ¶ster
    function showPasteNotification(message) {
      var notification = document.createElement('div');
      notification.className = 'paste-notification success';
      notification.innerHTML = `
        <div class="paste-notification-content">
          <span class="paste-icon">ð¸</span>
          <span class="paste-text">${message}</span>
        </div>
      `;
      
      // Notification'Ä± input alanÄ±nÄ±n Ã¼stÃ¼ne ekle
      const inputContainer = document.querySelector('.input-bar');
      if (inputContainer && inputContainer.parentNode) {
        inputContainer.parentNode.insertBefore(notification, inputContainer);
      }
      
      // 3 saniye sonra kaldÄ±r
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Provider deÄiÅim bildirimi gÃ¶ster
    function showProviderChangeNotification(providerDisplayName) {
      var notification = document.createElement('div');
      notification.className = 'paste-notification success';
      notification.innerHTML = `
        <div class="paste-notification-content">
          <span class="paste-icon">ð</span>
          <span class="paste-text">AI Provider deÄiÅtirildi: ${providerDisplayName}</span>
        </div>
      `;
      
      // Notification'Ä± input alanÄ±nÄ±n Ã¼stÃ¼ne ekle
      const inputContainer = document.querySelector('.input-bar');
      if (inputContainer && inputContainer.parentNode) {
        inputContainer.parentNode.insertBefore(notification, inputContainer);
      }
      
      // 3 saniye sonra kaldÄ±r
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Kopyalama fonksiyonu
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showFileNotification('â KopyalandÄ±!');
      }).catch(() => {
        showFileNotification('â Kopyalama baÅarÄ±sÄ±z', 'error');
      });
    }

    // Conversation history'yi UI'da gÃ¶ster
    function displayConversationHistory(history) {
      // Chat'i temizle
      chat.innerHTML = '';
      console.log('Displaying conversation history:', history);
      // Her mesajÄ± UI'da gÃ¶ster
      history.forEach(function(msg) {
        if (msg.role === 'user') {
          // KullanÄ±cÄ± mesajÄ±
          createUserMessage(msg.content, null);
        } else if (msg.role === 'assistant') {
          // Asistan mesajÄ±
          var botMsg = document.createElement('div');
          botMsg.className = 'message assistant';
          var mdBody = document.createElement('span');
          mdBody.className = 'markdown-body';
          
          // Markdown render et
          if (window.marked) {
            mdBody.innerHTML = window.marked.parse(msg.content, {
        highlight: function(code, lang) {
          if (lang && window.hljs.getLanguage(lang)) {
            return window.hljs.highlight(code, { language: lang }).value;
          }
          return window.hljs.highlightAuto(code).value;
        }
      });
            
            // Kod bloklarÄ±na kopyalama butonu ekle
            mdBody.querySelectorAll('pre code').forEach(function(block) {
        var pre = block.parentElement;
              if (pre) {
        var btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Kopyala';
        btn.onclick = function(e) {
          e.preventDefault();
          navigator.clipboard.writeText(block.textContent);
          btn.textContent = 'KopyalandÄ±!';
          setTimeout(function() { btn.textContent = 'Kopyala'; }, 1200);
        };
        pre.style.position = 'relative';
        pre.appendChild(btn);
              }
            });
          } else {
            mdBody.textContent = msg.content;
          }
          
          botMsg.appendChild(mdBody);
          chat.appendChild(botMsg);
        }
      });
      
      // Syntax highlighting'i yenile
      if (window.hljs) {
      window.hljs.highlightAll();
    }

      // Chat'i en alta kaydÄ±r
      chat.scrollTop = chat.scrollHeight;
    }

    // Mesaj gÃ¶nderme fonksiyonu
    function sendMessage() {
      if (!input || !chat || !vscode) {
        return;
      }

      var value = input.value.trim();
      if (!value) return;
      
      // EÄer zaten loading durumundaysa, yeni mesaj gÃ¶nderme
      if (isLoading) {
        return;
      }
      
      // KullanÄ±cÄ± mesajÄ±nÄ± ekle
      createUserMessage(value, selectedImage);
      input.value = '';
      chat.scrollTop = chat.scrollHeight;
      
      // Loading state'ini aktif et (kullanÄ±cÄ± mesajÄ±ndan sonra)
      setLoadingState(true);
      
      // MesajÄ± history'ye ekle
      addMessageToHistory('user', value);
      
      // Son gÃ¶nderilen mesajÄ± sakla (retry iÃ§in)
      lastFailedMessage = {
        text: value,
        imageData: selectedImage
      };
      
      // VSCode'a mesaj gÃ¶nder
      try {
        const messageData = { command: 'sendPrompt', text: value };
        
        // Resim varsa ekle
        if (selectedImage) {
          messageData.imageData = selectedImage;
        }
        
        vscode.postMessage(messageData);
        
        // Resmi temizle
        removeImage();
      } catch (error) {
        console.error('Error sending message:', error);
        setLoadingState(false); // Hata durumunda loading'i kapat
      }
    }

    // VSCode'dan gelen mesajlarÄ± dinle
    window.addEventListener('message', function(event) {
      const message = event.data;
      console.log('Received message from VSCode:', message);
      switch (message.command) {
        case 'addResponse':
          // Loading state'ini kapat
          setLoadingState(false);
          
          // BaÅarÄ±lÄ± yanÄ±t geldi, son baÅarÄ±sÄ±z mesajÄ± temizle
          lastFailedMessage = null;
          
          // Asistan mesajÄ±nÄ± ekle
        var botMsg = document.createElement('div');
        botMsg.className = 'message assistant';
        var mdBody = document.createElement('span');
        mdBody.className = 'markdown-body';
          
          if (message.html) {
            // Extension'dan gelen render edilmiÅ HTML
            mdBody.innerHTML = message.html;
          } else if (message.text) {
            // Ham markdown metni - webview tarafÄ±nda render et
            if (window.marked) {
              mdBody.innerHTML = window.marked.parse(message.text, {
                highlight: function(code, lang) {
                  if (lang && window.hljs.getLanguage(lang)) {
                    return window.hljs.highlight(code, { language: lang }).value;
                  }
                  return window.hljs.highlightAuto(code).value;
                }
              });
              
              // Kod bloklarÄ±na kopyalama butonu ekle
              mdBody.querySelectorAll('pre code').forEach(function(block) {
                var pre = block.parentElement;
                if (pre) {
                  var btn = document.createElement('button');
                  btn.className = 'copy-btn';
                  btn.textContent = 'Kopyala';
                  btn.onclick = function(e) {
                    e.preventDefault();
                    navigator.clipboard.writeText(block.textContent);
                    btn.textContent = 'KopyalandÄ±!';
                    setTimeout(function() { btn.textContent = 'Kopyala'; }, 1200);
                  };
                  pre.style.position = 'relative';
                  pre.appendChild(btn);
                }
              });
            } else {
              mdBody.textContent = message.text;
            }
          }
          
        botMsg.appendChild(mdBody);
        chat.appendChild(botMsg);
          
          // Asistan mesajÄ±nÄ± history'ye ekle
          if (message.html) {
            // HTML'den text Ã§Ä±kar (basit yÃ¶ntem)
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = message.html;
            addMessageToHistory('assistant', tempDiv.textContent || tempDiv.innerText || '');
          } else if (message.text) {
            addMessageToHistory('assistant', message.text);
          }
          
          // Syntax highlighting'i yenile
          if (window.hljs) {
        window.hljs.highlightAll();
          }
        chat.scrollTop = chat.scrollHeight;
          break;
          
        case 'historyLoaded':
          // Conversation history'yi yÃ¼kle
          conversationHistory = message.history || [];
          
          // EÄer history varsa, UI'da gÃ¶ster
          if (conversationHistory.length > 0) {
            displayConversationHistory(conversationHistory);
          } else {
            console.log('No conversation history found.');
            // History yoksa hoÅ geldin mesajÄ±nÄ± gÃ¶ster
            addWelcomeMessage();
          }
          break;
          
        case 'chatCleared':
          // Chat temizlendi
          conversationHistory = [];
          break;
          
        case 'fileContent':
          // Dosya iÃ§eriÄi alÄ±ndÄ±
          showFileContent(message.filePath, message.content);
          break;
          
        case 'fileWritten':
          // Dosya yazÄ±ldÄ±
          showFileNotification('â Dosya baÅarÄ±yla yazÄ±ldÄ±: ' + message.filePath);
          break;
          
        case 'fileTree':
          // Dosya aÄacÄ± alÄ±ndÄ±
          showFileTree(message.tree);
          break;
          
        case 'projectFiles':
          // Proje dosyalarÄ± alÄ±ndÄ±
          showProjectFiles(message.files);
          break;
          
        case 'fileError':
          // Dosya hatasÄ±
          showFileNotification('â Hata: ' + message.error, 'error');
          break;
          
        case 'currentProvider':
          // Mevcut provider bilgisi alÄ±ndÄ±
          currentProvider = message.provider;
          updateProviderUI(message.provider);
          break;
          
        case 'providerChanged':
          // Provider deÄiÅti
          currentProvider = message.provider;
          updateProviderUI(message.provider);
          
          // Provider deÄiÅtiÄinde bildirimi gÃ¶ster
          showProviderChangeNotification(message.displayName);
          break;
      }
    });

    // Sayfa yÃ¼klendiÄinde initialize et
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeWebview);
    } else {
      initializeWebview();
    }
  </script>
</body>
</html> 